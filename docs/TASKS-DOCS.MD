# üïô M√≥dulo de Tarefas Agendadas - Cooperescrita

## üìã Vis√£o Geral

O m√≥dulo de Tarefas (Tasks) da Cooperescrita √© respons√°vel por executar opera√ß√µes de manuten√ß√£o do sistema em per√≠odos programados. Ele utiliza o agendador de tarefas (scheduler) do NestJS para executar rotinas que mant√™m a integridade e efici√™ncia da aplica√ß√£o.

### üèóÔ∏è Arquitetura

O sistema de tarefas agendadas segue uma arquitetura simples e eficaz:

1. **TasksService**: Servi√ßo principal que define e executa as tarefas agendadas
2. **@nestjs/schedule**: Decorator `@Cron` para definir quando as tarefas s√£o executadas
3. **Integra√ß√£o com outros m√≥dulos**: Como EmailsService para notifica√ß√µes e UsersRepository para manipula√ß√£o de dados

## üîÑ Tarefas Agendadas

### 1. Limpeza de Usu√°rios N√£o Verificados

**Cronograma**: Todos os dias √†s 3h da manh√£ (`CronExpression.EVERY_DAY_AT_3AM`)

**Descri√ß√£o**: Remove contas de usu√°rios que foram criadas h√° mais de um per√≠odo configur√°vel (padr√£o: 24 horas) e que n√£o tiveram seu email verificado.

**Prop√≥sito**:

- Prevenir ac√∫mulo de contas inativas no banco de dados
- Reduzir vulnerabilidades de seguran√ßa de contas abandonadas
- Manter dados anal√≠ticos mais precisos

### 2. Limpeza de C√≥digos de Verifica√ß√£o Expirados

**Cronograma**: Todos os dias √† meia-noite (`CronExpression.EVERY_DAY_AT_MIDNIGHT`)

**Descri√ß√£o**: Limpa c√≥digos de verifica√ß√£o 2FA e tokens tempor√°rios que j√° expiraram e n√£o s√£o mais v√°lidos.

**Prop√≥sito**:

- Melhorar a higiene do banco de dados
- Reduzir dados pessoais armazenados ap√≥s seu uso
- Minimizar o tamanho do banco de dados

## ‚öôÔ∏è Configura√ß√£o

### Vari√°veis de Ambiente
```

# Tempo (em horas) para considerar uma conta n√£o verificada como expirada

USER_VERIFICATION_EXPIRY_HOURS=24

# Ambiente da aplica√ß√£o (development/production)

NODE_ENV=development

# Email do administrador para relat√≥rios (usado pelo EmailsService)

MAIN_ADMIN=admin@cooperescrita.com

````

### Customiza√ß√£o do Cronograma

As express√µes cron podem ser modificadas no c√≥digo para atender a requisitos espec√≠ficos. Exemplos de express√µes dispon√≠veis:

```typescript
// Exemplos de express√µes dispon√≠veis no CronExpression
CronExpression.EVERY_30_MINUTES
CronExpression.EVERY_HOUR
CronExpression.EVERY_DAY_AT_NOON
CronExpression.EVERY_WEEKEND
````

## üõ†Ô∏è Como Funciona

### Limpeza de Usu√°rios N√£o Verificados

1. O sistema calcula a data de corte baseada no tempo configurado
2. Consulta o banco de dados por usu√°rios n√£o verificados criados antes dessa data
3. Se encontrados usu√°rios para remo√ß√£o:
   - Gera logs detalhados (em ambiente de desenvolvimento)
   - Envia relat√≥rio para administrador se o n√∫mero for significativo (>10)
   - Remove os usu√°rios do banco de dados
4. Registra m√©tricas de execu√ß√£o e tempo de processamento

### Limpeza de C√≥digos de Verifica√ß√£o

1. Identifica usu√°rios com c√≥digos de verifica√ß√£o expirados
2. Limpa esses c√≥digos (definindo como null)
3. Salva as atualiza√ß√µes no banco de dados
4. Registra logs de resultado

### Relat√≥rios e Notifica√ß√µes

Para opera√ß√µes significativas ou falhas, o sistema:

1. Compila estat√≠sticas relevantes (como idade m√©dia das contas, dom√≠nios mais comuns)
2. Formata um relat√≥rio estruturado
3. Envia para o email administrativo definido na configura√ß√£o

## üìä Monitoramento e Troubleshooting

### Logs Dispon√≠veis

O m√≥dulo gera logs detalhados para rastrear seu funcionamento:

- **Info**: In√≠cio e conclus√£o de tarefas, contagens de itens afetados
- **Debug**: Detalhes espec√≠ficos de itens processados (ambiente de desenvolvimento)
- **Warn**: Problemas n√£o cr√≠ticos, como falha ao enviar relat√≥rio
- **Error**: Falhas na execu√ß√£o das tarefas

### Exemplo de Logs

```
[Nest] 18356  - 04/12/2023, 3:00:00 AM     LOG [TasksService] Iniciando limpeza de usu√°rios n√£o verificados...
[Nest] 18356  - 04/12/2023, 3:00:01 AM     LOG [TasksService] Encontrados 15 usu√°rios n√£o verificados para remo√ß√£o.
[Nest] 18356  - 04/12/2023, 3:00:02 AM     LOG [TasksService] Limpeza conclu√≠da. Removidos 15 usu√°rios em 1852ms.
```

### Resolu√ß√£o de Problemas

1. **Tarefa n√£o est√° executando**:

   - Verifique se o m√≥dulo `ScheduleModule` est√° importado corretamente no AppModule
   - Confirme que n√£o h√° erros na inicializa√ß√£o da aplica√ß√£o

2. **Erros durante a execu√ß√£o**:

   - Verifique os logs de erro
   - Confirme que a conex√£o com o banco de dados est√° est√°vel
   - Verifique permiss√µes do usu√°rio do banco de dados

3. **Relat√≥rios n√£o est√£o sendo enviados**:
   - Confirme as configura√ß√µes do m√≥dulo de emails
   - Verifique se `MAIN_ADMIN` est√° configurado corretamente

## üîß Estendendo o M√≥dulo

### Adicionando Nova Tarefa Agendada

```typescript
import { Injectable } from '@nestjs/common';
import { Cron, CronExpression } from '@nestjs/schedule';

@Injectable()
export class TasksService {
  // ...c√≥digo existente...

  @Cron(CronExpression.EVERY_WEEK)
  async minhaNovaTaskSemanal() {
    this.logger.log('Iniciando minha tarefa semanal...');

    try {
      // Sua l√≥gica aqui

      this.logger.log('Tarefa semanal conclu√≠da com sucesso!');
    } catch (error) {
      this.logger.error(
        `Erro na tarefa semanal: ${error.message}`,
        error.stack,
      );
    }
  }
}
```

### Criando Tarefas Din√¢micas ou Condicionais

```typescript
import { Injectable } from '@nestjs/common';
import { Cron, SchedulerRegistry } from '@nestjs/schedule';
import { CronJob } from 'cron';

@Injectable()
export class TasksService {
  constructor(
    // ...outras inje√ß√µes...
    private schedulerRegistry: SchedulerRegistry,
  ) {
    // Criar tarefa condicionalmente
    if (process.env.FEATURE_FLAG_X === 'true') {
      this.createDynamicJob();
    }
  }

  private createDynamicJob() {
    const job = new CronJob('0 0 * * *', () => {
      // Esta fun√ß√£o executa todos os dias √† meia-noite
      this.logger.log('Executando tarefa din√¢mica...');
    });

    this.schedulerRegistry.addCronJob('minha-tarefa-dinamica', job);
    job.start();
  }
}
```

## üîê Seguran√ßa e Boas Pr√°ticas

1. **Opera√ß√µes Destrutivas**

   - Implemente confirma√ß√µes ou logs detalhados para opera√ß√µes que excluem dados
   - Considere soft-deletes em vez de remo√ß√£o permanente para dados importantes

2. **Performance**

   - Agende tarefas pesadas para hor√°rios de baixo uso do sistema
   - Implemente pagina√ß√£o para processamento de grandes conjuntos de dados

3. **Toler√¢ncia a Falhas**

   - Todas as tarefas devem ter tratamento de exce√ß√µes robusto
   - Considere implementar mecanismo de retry para opera√ß√µes cr√≠ticas

4. **Logging**
   - Registre m√©tricas de cada execu√ß√£o (itens processados, tempo de execu√ß√£o)
   - Mantenha diferentes n√≠veis de log baseados no ambiente e severidade

## üìö Refer√™ncias

- [Documenta√ß√£o do NestJS - Task Scheduling](https://docs.nestjs.com/techniques/task-scheduling)
- [Biblioteca node-cron](https://github.com/node-cron/node-cron)
- [Express√µes Cron - Explica√ß√£o](https://crontab.guru/)

---

Esta documenta√ß√£o descreve o m√≥dulo de tarefas agendadas da Cooperescrita. Para quest√µes t√©cnicas ou problemas espec√≠ficos, entre em contato com a equipe de desenvolvimento.
